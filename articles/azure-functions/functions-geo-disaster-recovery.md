---
title: Azure Functions 异地灾难恢复和高可用性
description: 如何使用地理区域实现冗余，以及如何在 Azure Functions 中故障转移。
author: wesmc7777
ms.assetid: 9058fb2f-8a93-4036-a921-97a0772f503c
ms.topic: conceptual
ms.date: 02/13/2020
ms.author: v-junlch
ms.openlocfilehash: 02bd2b4f7078fd245df7ce62dbdd34899b3dbae4
ms.sourcegitcommit: ada94ca4685855f58616e4bf1dd5ca757878dfdc
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/18/2020
ms.locfileid: "77428513"
---
# <a name="azure-functions-geo-disaster-recovery"></a>Azure Functions 异地灾难恢复

在整个区域或数据中心遭遇停机的情况下，在不同区域进行计算以实现连续处理就显得至关重要。  本文将介绍一些可以用来部署函数以实现灾难恢复的策略。

## <a name="basic-concepts"></a>基本概念

Azure Functions 在特定区域运行。  若要提高可用性，可将相同函数部署到多个区域。  在多个区域中时，可以让函数以“主动/主动”或“主动/被动”模式运行。    

* 主动/主动。 两个区域都主动接收事件（采用重复或循环方式）。 建议将“主动/主动”用于 HTTPS 函数，与 Azure Front Door 组合使用。
* 主动/被动。 一个区域主动接收事件，另一个区域（次要区域）处于空闲状态。  需要进行故障转移时，次要区域激活，开始接管处理操作。  建议将它用于非 HTTP 功能，例如服务总线和事件中心。

## <a name="activeactive-for-non-https-functions"></a>用于非 HTTPS 功能的“主动/主动”模式

仍可针对非 HTTPS 功能实现“主动/主动”部署。  但是，需要考虑这两个区域如何互相交互或协调。  如果向两个区域部署了同一函数应用，每个区域都在同一服务总线队列上触发，那么在对该队列执行取消排队操作时，这两个区域属于竞争性使用者。  虽然这意味着每条消息仅由多个实例中的一个进行处理，但也意味着在单个服务总线上仍然存在单一故障点。  如果部署两个服务总线队列（一个在主要区域，一个在次要区域），这两个函数应用指向其区域队列，则现在的难点在于，如何在这两个区域之间分发队列消息。  通常情况下，这意味着每个发布者都会尝试将消息发布到两个区域，  每条消息都由两个活动的函数应用进行处理。  虽然这样会形成一个“主动/主动”模式，但也会在复制计算以及在何时合并数据或以何种方式合并数据方面制造其他难题。  出于这些原因，建议由非 HTTPS 触发器来使用“主动/主动”模式。

## <a name="activepassive-for-non-https-functions"></a>用于非 HTTPS 功能的“主动/被动”模式

使用“主动/被动”模式时，每次只有一个函数处理一条消息，但在发生灾难时可以故障转移到次要区域。  Azure Functions 可以与 [Azure 服务总线异地恢复](../service-bus-messaging/service-bus-geo-dr.md)配合使用。

以 Azure 事件中心触发器为例，主动/被动模式涉及以下操作：

* 将 Azure 事件中心同时部署到主要区域和次要区域。
* 启用异地灾难灾难，以配对主要和次要事件中心。  这还会创建一个“别名”，用于连接到事件中心以及从主要事件中心切换到次要事件中心，而无需更改连接信息。
* 将函数应用同时部署到主要区域和次要区域。
* 函数应用基于其各自事件中心的直接（非别名）连接字符串触发。  
* 事件中心的发布服务器应发布到别名连接字符串。 

![主动-被动示例体系结构](./media/functions-geo-dr/active-passive.png)

在故障转移之前，发送到共享别名的发布服务器将路由到主要事件中心。  主要函数应用专门侦听主要事件中心。  次要函数应用处于被动且空闲状态。  发起故障转移后，发送到共享别名的发布服务器现在会路由到次要事件中心。  次要函数应用现在处于主动状态并开始自动触发。  完全可以从事件中心驱动到次要区域的有效故障转移，仅当相应的事件中心处于主动状态时，函数才变为主动状态。

阅读有关使用[服务总线](../service-bus-messaging/service-bus-geo-dr.md)进行故障转移的详细信息和注意事项。


